## í”„ë¡œì íŠ¸ ëª©ì  (Instaclone)

ì¸ìŠ¤íƒ€ê·¸ë¨ í´ë¡  ì½”ë”© Backend.

## ì„¤ì¹˜

<details>
<summary>apollo-server , graphql ì„¤ì¹˜ </summary>
  
```Shell
# NPM
npm install apollo-server graphql

# yarn

yarn add apollo-server graphql

````
</details>
<details>
<summary>babel ì„¤ì¹˜ </summary>

```Shell
# NPM
npm install --save-dev @babel/core
npm install @babel/preset-env @babel/node --save-dev


# yarn
yarn add --save-dev @babel/core
yarn add @babel/preset-env @babel/node --save-dev
````

</details>

<details>
<summary>Prisma ì„¤ì¹˜ </summary>

```Shell
# NPM
npm install prisma -D

# yarn
yarn add prisma -D
```

</details>

<details>
<summary>Prisma client ì„¤ì¹˜ </summary>

```Shell
# NPM
npm install @prisma/client

# yarn
yarn add @prisma/client
```

</details>

<details>
<summary>graphql tools ì„¤ì¹˜ </summary>

```Shell
# NPM
npm i graphql-tools

# yarn
yarn add graphql-tools]
```

</details>

<details>
<summary>dotenv ì„¤ì¹˜</summary>

```Shell
# NPM
npm i dotenv

# yarn
yarn add dotenv
```

</details>

## Babel ì„¤ì •

1. babel.config.json íŒŒì¼ ìƒì„± í›„ ì•„ë˜ ì½”ë“œ ì¶”ê°€

```json
{
    "presets": ["@babel/preset-env"]
}
```

2. package.json script ìˆ˜ì •

```json
"script": {
	"dev" : "nodemone --exec babel-node index"
}
```

## Apollo server

-   ì˜ˆì œ

```javascript
import { ApolloServer, gql } from "apollo-server";
// const { ApolloServer, gql } = require('apollo-server'); ìœ„ì™€ ê°™ì´ ëŒ€ì²´
// ë‹¨, node ë²„ì „ì´ ë§ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ê°€ ë‚¨ => bable ì„¤ì¹˜!

// The GraphQL schema
const typeDefs = gql`
    type Query {
        "A simple type for getting started!"
        hello: String
    }
`;

// A map of functions which return data for the schema.
const resolvers = {
    Query: {
        hello: () => "world",
    },
};

const server = new ApolloServer({
    typeDefs,
    resolvers,
});

server.listen().then(({ url }) => {
    console.log(`ğŸš€ Server ready at ${url}`);
});
```
- **Subscriptions**
	- ì˜¤ë«ë™ì•ˆ ì§€ì†ë˜ëŠ” GraphQlì˜ read operation
	- httpê°€ ì•„ë‹ˆê³  websocket í”„ë¡œí† ì½œ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©
	- apollo serverì— ê¸°ë³¸ì ìœ¼ë¡œ **`PubSub`** ê°€ ë‚´ì¥ ë˜ì–´ìˆì§€ë§Œ êµìœ¡ìš©ì— ì ë‹¹, ê·œëª¨ê°€ í° ì‹¤ì œ ìƒí’ˆì€ **`RedisPubSub`** ì™€ ê°™ì€ ë‹¤ë¥¸ pubsub ì´ìš©
	- ê¸°ë³¸ ì‚¬ìš©ë²•(ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©)
	```javascript
	import { PubSub, gql } from 'apollo-server';
	import {ApolloServer} from "apollo-server-express"
	import http from "http";
	import express from "express";
	
	
	const pubsub = new PubSub();
	const PORT = 4000;
	
	// Schema definition
	const typeDefs = gql`
		 type Query {
			currentNumber: Int
		}

		 type Subscription {
			numberIncremented: Int
		}
	`;

	// Resolver map
	const resolvers = {
		Query: {
			currentNumber() {
				return currentNumber;
			}
		},
		Subscription: {
			numberIncremented: {
				//asyncIterator : triggerë“¤ì„ listení•´ì¤Œ, triggerëŠ” Stringì´ë‹¤.
				subscribe: () => pubsub.asyncIterator(['NUMBER_INCREMENTED']),
			},
		}
	};
	
	const apollo = new ApolloServer({
  	typeDefs,
  	resolvers,
  	subscriptions: {
			path: '/subscriptions',
			onConnect: (connectionParams, webSocket, context) => {
				console.log('Client connected');
			},
			onDisconnect: (webSocket, context) => {
				console.log('Client disconnected')
			},
  	},
	});
	
	const app = express();
	apollo.applyMiddleware({ app });
	

	const httpServer = http.createServer(app);
	apollo.installSubscriptionHandlers(httpServer);

	httpServer.listen(PORT, () => {
			console.log(`Server is running on http://localhost:${PORT}`);
	});
	
	let currentNumber = 0;
	function incrementNumber() {
		currentNumber++;
		pubsub.publish('NUMBER_INCREMENTED', { numberIncremented: currentNumber });
		setTimeout(incrementNumber, 1000);
	}
	incrementNumber();
	
	```

## Prisma

-   `shell npx prisma init ` ëª…ë ¹ì–´ ì‹¤í–‰ => prisma/schema.prisma & .evn íŒŒì¼ ìƒì„±
-   .env íŒŒì¼ì— Database ì„¤ì •

```env
DATABASE_URL = 'postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=SCHEMA'
ex)
DATABASE_URL = 'postgresql://janedoe:janedoe@localhost:5432/janedoe?schema=hello-prisma'
```

-   **`USER`**: The name of your database user
-   **`PASSWORD`**: The password for your database user
-   **`PORT`**: The port where your database server is running (typicallyÂ **`5432`**Â for PostgreSQL)
-   **`DATABASE`**: The name of theÂ [database](https://www.postgresql.org/docs/12/manage-ag-overview.html)
-   **`SCHEMA`**: The name of theÂ [schema](https://www.postgresql.org/docs/12/ddl-schemas.html)Â inside the database

-   prisma/schema.prismaíŒŒì¼ ì˜ˆì œ

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String?
  posts   Post[]
  profile Profile?
}

```

íƒ€ì…ì— ?ê°€ ë¶™ìœ¼ë©´ unrequired ë¶™ì§€ ì•Šìœ¼ë©´ requiredë¡œ ì„¤ì •

-   ë°ì´í„° ë² ì´ìŠ¤ì— User í…Œì´ë¸” ìƒì„±
-   ëª…ë ¹ì°½ì— ì•„ë˜ ì½”ë“œ ì‹¤í–‰

```shell
npx prisma migrate dev init
```

## Prisma client

-   ì˜ˆì œ

```javascript
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

const userAccount = async ({ name, email }) => {
    await prisma.user.create({
        data: {
            name,
            email,
            posts: {
                create: { title: "Hello World" },
            },
            profile: {
                create: { bio: "I like turtles" },
            },
        },
    });
};

const allUsers = async () => {
    await prisma.user.findMany({
        include: {
            posts: true,
            profile: true,
        },
    });
};
```

-   prisma client ì¡°ê±´ ë° ì‚¬ìš©ë²• ì°¸ì¡°
-   Link: **https://www.prisma.io/docs/concepts/components/prisma-client/crud**

## graphql-tools

-   ê°™ì€ íŒ¨í„´ì˜ ì´ë¦„ì„ ê°€ì§„ íŒŒì¼ì„ í•œë²ˆì— ì°¾ì•„ merge ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
-   ì˜ˆì œ

```javascript
import { loadFilesSync, mergeTypeDefs, mergeResolvers } from "graphql-tools";

const loadedTypeDefs = loadFilesSync(`${__dirname}/**/*.typeDefs.js`);
const typeDefs = mergeTypeDefs(loadedTypeDefs);

const loadedResolvers = loadFilesSync(
    `${__dirname}/**/*.{queries,mutations}.js`
);
const resolvers = mergeResolvers(loadedResolvers);

const schema = makeExecutableSchema({ typeDefs, resolvers });
```

## dotenv

-   .envíŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆë‹¤.
-   ê°€ì¥ ìƒìœ„ í´ë”ì— ì„ ì–¸í•´ ì¤€ë‹¤.
-   ì‚¬ìš©ë²•

```js
require('dotenv').config()
import ...
...
...

const PORT = process.env.PORT;
```

## API ëª©ë¡

<details>
  <summary>User</summary>

-   [x] Create Account
-   [x] See Profile
-   [x] Login
-   [x] Edit Profile
-   [x] CHange Avatar (Image Upload)
-   [x] Follow User
-   [x] Unfollow User
-   [x] See Followers with Paginataion
-   [x] See Follwing with Paginataion
-   [x] Computed Fields
-   [x] Search Users

</details>
<details>
<summary>Photos</summary>

-   [x] Upload Photo (Parse #)
-   [x] See Photo
-   [x] See Hashtags
-   [x] Search Photos
-   [x] Edit Photo
-   [x] Like / Unlike Photo
-   [x] See Photo Likes
-   [x] See Photo Comments
-   [x] See Feed
-   [x] Delte Photo

</details>
<details>
<summary>Comments</summary>

-   [x] Comment on Photo
-   [x] Edit Comment
-   [x] Delete Comment
</details>
<details>
<summary>Refactor</summary>

-   [x] Mutation Responses

</details>
<details>
<summary>Extras</summary>
  
-   [x] S3 Image Upload

</details>
<details>
<summary>DMs</summary>
  
-    [x] See Rooms
-    [x] Send Message (Create Room)
-    [x] See Room
-    [x] Computed Fields
-    [x] See (Read) Message
-    [x] Realtime Messages

</details>

## ERROR

-   apollo-server fileupload ë¶€ë¶„ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë°œìƒ
-   fsë¥¼ í†µí•´ file readStreamì„ ìˆ˜í–‰í•œ í›„ ì „ì†¡ í–ˆì„ ê²½ìš°ì—ëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ìŒ.

```shell
(node:53998) [DEP0135] DeprecationWarning: ReadStream.prototype.open() is deprecated

(Use node --trace-deprecation ...to show where the warning was created)
```

ì›ì¸ : node.js v.14ì´í›„ë¡œ ë‚˜ì˜¤ëŠ” ì—ëŸ¬..

í•´ê²° ë°©ë²•

```json
// package.json
// 1. ë§¨ ì•„ë˜ì— ì¶”ê°€
"resolutions": {
    "fs-capacitor": "^6.2.0",
    "graphql-upload": "^11.0.0"
  }

// 2. preinstall script ìƒì„±

"preinstall":"npx npm-force-resolutions"
```

[pakage.json]

1. ìœ„ì™€ ê°™ì´ package.jsonì— ì¶”ê°€í›„ node_modules ì‚­ì œ
2. `shell npm cache clean --force` ëª…ë ¹ì–´ ì‹¤í–‰ìœ¼ë¡œ ìºì‹œ ì´ˆê¸°í™”
3. `shell npm i ` ì‹¤í–‰
